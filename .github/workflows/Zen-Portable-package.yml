# GitHub Actions 工作流：Zen 浏览器便携版打包
name: Zen Portable Build

on:
  workflow_dispatch:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 0 * * *'

jobs:
  build-zen:
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write

    steps:
    # 检出代码仓库
    - name: Checkout repository
      uses: actions/checkout@v4

    # 检查 Zen 浏览器版本更新
    - name: Check Zen Browser version
      id: version-check
      run: |
        # 获取最新版本信息
        $latest_url = "https://api.github.com/repos/zen-browser/desktop/releases/latest"
        $response = Invoke-RestMethod -Uri $latest_url
        $latest_version = $response.tag_name
        echo "Latest version: $latest_version"
        echo "zen_version=$latest_version" >> $env:GITHUB_OUTPUT
        
        # 检查触发事件类型
        $trigger_event = "${{ github.event_name }}"
        $should_build = "true"
        $build_reason = $trigger_event
        
        # 定时触发时检查版本更新
        if ($trigger_event -eq "schedule") {
          $version_file = "last_version.txt"
          if (Test-Path $version_file) {
            $last_version = Get-Content $version_file
            if ($last_version -eq $latest_version) {
              echo "No update available. Skipping build."
              $should_build = "false"
              $build_reason = "no_update"
            } else {
              $build_reason = "version_update"
            }
          } else {
            $build_reason = "first_run"
          }
        }
        
        # 保存版本信息
        $latest_version | Out-File -FilePath "last_version.txt" -Encoding UTF8
        echo "should_build=$should_build" >> $env:GITHUB_OUTPUT
        echo "build_reason=$build_reason" >> $env:GITHUB_OUTPUT

    # 下载并解压 Zen 浏览器
    - name: Download and Extract Zen Browser
      if: steps.version-check.outputs.should_build == 'true'
      run: |
        # 下载 Zen 浏览器
        $url = "https://github.com/zen-browser/desktop/releases/latest/download/zen.installer.exe"
        $output = "$env:GITHUB_WORKSPACE\zen-installer.exe"
        Invoke-WebRequest -Uri $url -OutFile $output
        
        # 解压到临时目录
        New-Item -ItemType Directory -Force -Path "D:\zen"
        Set-Location -Path "D:\zen"
        7z x "$output" -y

    # 复制 libportable 工具并创建便携版
    - name: Create Portable Package
      if: steps.version-check.outputs.should_build == 'true'
      run: |
        # 复制 libportable 工具
        $targetDir = "D:\zen\core"
        New-Item -ItemType Directory -Force -Path $targetDir
        Copy-Item -Path "$env:GITHUB_WORKSPACE\libportable\*" -Destination $targetDir -Recurse -Force
        
        # 复制开始.bat到zen目录
        Copy-Item -Path "$env:GITHUB_WORKSPACE\开始.bat" -Destination "D:\zen" -Force
        
        # 运行便携版创建脚本
        Set-Location -Path $targetDir
        $injectScript = "$targetDir\injectpe.bat"
        if (Test-Path $injectScript) {
          cmd /c $injectScript
        } else {
          Write-Error "批处理文件未找到: $injectScript"
          exit 1
        }
        
        # 等待一下确保文件操作完成
        Start-Sleep -Seconds 2
        
        # 重命名文件夹
        Set-Location -Path "D:\zen"
        if (Test-Path "D:\zen\core") {
          Rename-Item -Path "D:\zen\core" -NewName "Zen" -Force
        }
      continue-on-error: true

    # 打包便携版文件
    - name: Package Portable Build
      if: steps.version-check.outputs.should_build == 'true'
      run: |
        # 打包为便携版压缩包
        $outputZip = "$env:GITHUB_WORKSPACE\Zen.zip"
        7z a -tzip "$outputZip" "D:\zen"

    # 创建 GitHub Release 并上传文件
    - name: Create Release and Upload Package
      if: steps.version-check.outputs.should_build == 'true'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version-check.outputs.zen_version }}
        name: Zen Browser Portable ${{ steps.version-check.outputs.zen_version }}
        body: |
          Zen Browser ${{ steps.version-check.outputs.zen_version }} 便携版
          这是一个自动构建的 Zen 浏览器便携版本，基于 libportable 项目。

          使用方法：
          1. 下载 [Zen.zip](https://github.com/JBCode-WebProject/Zen-Libportable/releases/latest/download/Zen.zip) 文件
          2. 解压到任意目录
          3. 运行 开始.bat 即可创建快捷方式
          
          ### 版本信息
          - 构建时间：${{ github.run_number }}
          - 构建环境：${{ runner.os }}
        draft: false
        prerelease: false
        files: |
          ${{ github.workspace }}\Zen.zip

# 清理旧的构建记录
cleanup:
    # 建议加上 if: always()，这样即使 build 失败了，也能清理旧记录
    if: always()
    needs: build # (可选) 如果你希望 build 跑完再清理，就加上这行
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 10