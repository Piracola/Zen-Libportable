# 构建便携版Zen浏览器的GitHub工作流
name: Build Portable Zen Browser

# 触发条件：推送到main分支、手动触发或定时检查Zen新版本
on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # 每天UTC时间08:00检查一次Zen浏览器是否有新版本发布
    - cron: '0 8 * * *'

jobs:
  build:
    # 使用Windows最新版本作为运行环境
    runs-on: windows-latest

    steps:
    # 检出代码仓库
    - name: Checkout repository
      uses: actions/checkout@v3

    # 安装7-Zip压缩工具
    - name: Install 7-Zip
      uses: milliewalky/setup-7-zip@v2

    # 创建Cache目录用于存储安装包文件
    - name: Create Cache directory
      run: |
        mkdir Cache
      shell: bash

    # 下载libportable工具包到Cache目录
    - name: Download libportable
      run: |
        curl -L -o Cache/portable_bin.7z https://sourceforge.net/projects/libportable/files/Tools/portable_bin.7z/download
      shell: bash

    # 下载Zen浏览器安装包到Cache目录
    - name: Download Zen Browser
      run: |
        curl -L -o Cache/zen.installer.exe "https://github.com/zen-browser/desktop/releases/latest/download/zen.installer.exe"
      shell: bash


    # 从Cache目录解压Zen浏览器安装包到根目录
    - name: Extract Zen Browser from Cache to root
      run: |
        7z x Cache/zen.installer.exe
      shell: bash

    # 打印解压后的根目录内容
    - name: Display root directory contents after extraction
      run: |
        dir
      shell: cmd

    - name: Delete setup.exe
      run: |
        del setup.exe
      shell: cmd

    # 将解压得到的core文件夹重命名为Zen
    - name: Rename core folder to Zen
      run: |
        ren core Zen
      shell: cmd
      
    # 从Cache目录将libportable工具包内容解压到临时目录
    - name: Extract libportable files from Cache
      run: |
        7z x Cache/portable_bin.7z -oportable_temp -y
      shell: bash

    # 检查libportable解压后的文件结构
    - name: Check libportable files
      run: |
        echo "Checking libportable files..."
        dir portable_temp
        echo "\nChecking for portable_bin directory..."
        if exist portable_temp\portable_bin dir portable_temp\portable_bin
      shell: cmd

    # 复制libportable文件到Zen目录
    - name: Copy libportable files to Zen directory
      run: |
        if exist portable_temp\portable_bin (
          echo "Found portable_bin directory, copying files..."
          xcopy /s /e /y portable_temp\portable_bin\* Zen\
        ) else (
          echo "No portable_bin directory found, copying all extracted files..."
          xcopy /s /e /y portable_temp\* Zen\
        )
      shell: cmd

    # 打印最终目录结构
    - name: Display final directory structure
      run: |
        echo "Final directory structure:"
        dir
        echo "\nZen directory contents:"
        dir Zen
      shell: cmd

    # 使用仓库内的portable.ini文件替代libportable自带的ini文件
    - name: Replace portable.ini with repository version
      run: |
        copy portable.ini Zen\portable.ini /y
      shell: cmd

    # 执行便携化处理
    - name: Apply portable patch
      run: |
        cd Zen
        echo "Applying portability patch to zen.exe..."
        if exist setdll64.exe (
          setdll64.exe zen.exe portable64.dll
        ) else (
          echo "setdll64.exe not found! Cannot apply patch."
          exit 1
        )
      shell: cmd

    # 清理临时文件
    - name: Clean up temporary files
      run: |
        echo "Cleaning up temporary files..."
        if exist portable_temp rmdir /s /q portable_temp
        if exist Cache rmdir /s /q Cache
      shell: cmd

    # 上传构建完成的便携版Zen浏览器作为构建产物
    - name: Upload Portable Zen Browser as artifact
      uses: actions/upload-artifact@v4
      with:
        name: portable-zen-browser
        path: Zen/