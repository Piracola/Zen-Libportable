# 构建便携版Zen浏览器的GitHub工作流
name: Build Portable Zen Browser

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install 7-Zip
      uses: milliewalky/setup-7-zip@v2

    - name: Download libportable
      run: |
        curl -L -o portable_bin.7z https://sourceforge.net/projects/libportable/files/Tools/portable_bin.7z/download
      shell: bash

    - name: Extract libportable with full paths
      run: |
        7z x portable_bin.7z -oportable_bin -y
      shell: bash

    - name: Download Zen Browser
      run: |
        curl -L -o zen.installer.exe "https://github.com/zen-browser/desktop/releases/latest/download/zen.installer.exe"
      shell: bash

    - name: Extract Zen Browser
      run: |
        7z x zen.installer.exe
      shell: bash

    - name: Delete setup.exe
      run: |
        del setup.exe
      shell: cmd

    - name: Rename core folder to Zen
      run: |
        ren core Zen
      shell: cmd
      
    # 使用 robocopy 将 libportable 文件合并到 Zen 目录
    - name: Copy libportable files to Zen directory
      run: |
        robocopy portable_bin\portable_bin Zen /E
      shell: cmd

    # [新增] 清理已复制的源目录
    - name: Clean up source portable_bin directory
      run: |
        rmdir /s /q portable_bin
      shell: cmd

    - name: Replace portable.ini with repository version
      run: |
        copy portable.ini Zen\portable.ini /y
      shell: cmd

    - name: Run injectpe.bat
      run: |
        cd Zen
        .\injectpe.bat
      shell: cmd

    - name: Upload Portable Zen Browser as artifact
      uses: actions/upload-artifact@v4
      with:
        name: portable-zen-browser
        path: Zen/